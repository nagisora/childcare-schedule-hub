# 03 決定事項・採用方針

## 決定日

2025-01-22（初版作成）
2025-01-22（調査結果を反映して更新）

## MVPでの方針

### 採用した技術選択肢

**調査結果に基づく判断**（2025-01-22更新）:
- 名古屋市サイトの一覧ページにはInstagramリンクが含まれていない
- **詳細ページにもInstagramリンクが含まれていない**（サンプル3件を確認済み）
- 現在、すべての施設で `instagram_url` は `null`

**採用方針**:
1. **InstagramアカウントURLの取得**: 手動調査・登録（詳細ページの確認後に判断）
2. **スケジュールURLの登録**: 手動登録
3. **表示方法**: Instagram公式API（oEmbed）

### 実装方針

**InstagramアカウントURLの取得**:
- **MVPでは手動調査・登録を基本とする**（確定）
  - 施設名や住所から検索してInstagramアカウントを特定
  - 見つかったアカウントを `facilities.instagram_url` に手動登録
  - すべての施設で埋まっていなくてもOK（部分的な対応で可）
- **詳細ページの確認結果**（2025-01-22）
  - サンプル3件の詳細ページを確認した結果、Instagramリンクが含まれていないことを確認
  - **結論**: スクレイピングスクリプトの拡張は現時点では不要
  - 将来的に名古屋市サイトが更新され、Instagramリンクが追加される可能性はあるが、優先度は低い

**スケジュールURLの登録**:
- **手動登録を基本とする**
  - 人がInstagramアカウントを確認し、スケジュールURLを `schedules.instagram_post_url` に登録
  - すべての施設で埋まっていなくてもOK（MVPでは部分的な対応で可）
  - 投稿形式がバラバラでも柔軟に対応可能

**表示方法**:
- **Instagram公式API（oEmbed）を使用**
  - 投稿URLが登録されている場合のみ埋め込み表示
  - 投稿URLが無効な場合は、画像URL（`schedules.image_url`）をフォールバック表示
  - [03 API 仕様](../03-api.md) 3.1節（Instagram Embed API）に準拠

---

## schedulesテーブルの更新ポリシー

### データ投入方法

**手動入力フロー**:
- **Supabase Studio での操作**:
  1. Supabase プロジェクトのダッシュボードにアクセス
  2. Table Editor > `schedules` テーブルを開く
  3. **Insert** > **Insert row** をクリック
  4. 以下の項目を入力:
     - `facility_id`: 対象施設のUUID
     - `instagram_post_url`: Instagram投稿URL（例: `https://www.instagram.com/p/...`）
     - `published_month`: 対象月の1日（例: `2025-01-01`）
     - `status`: `published`
  5. **Save** をクリック
- **SQLでの操作**:
  ```sql
  INSERT INTO schedules (facility_id, instagram_post_url, published_month, status)
  VALUES (
    'facility-uuid-here',
    'https://www.instagram.com/p/...',
    '2025-01-01',
    'published'
  );
  ```

**更新頻度**:
- **月1回程度を目安とする**
  - 各施設の月間スケジュールが更新されるタイミングに合わせて更新
  - すべての施設で同時に更新する必要はなく、更新された施設のみ更新すればOK

**データ品質管理**:
- **重複チェック**: `(facility_id, published_month)` の組み合わせで一意制約があるため、重複登録は不可
- **バリデーション**: 
  - `instagram_post_url` は有効なInstagram投稿URLであることを確認
  - `published_month` は月の1日であることを確認（例: `2025-01-01`）

### データ構造

**schedulesテーブルの利用方針**:
- `instagram_post_url`: Instagram投稿URLを保存。oEmbed APIで埋め込みHTMLを取得する際に使用
- `image_url`: スケジュール画像のURL（将来拡張用）。現在は未使用
- `embed_html`: oEmbed APIで取得した埋め込みHTMLをキャッシュ（将来拡張用）。現在は未使用
- `published_month`: 対象月の1日で管理。`UNIQUE (facility_id, published_month)` 制約により重複を防止

**参考**: [02 設計資料](../02-design.md) 3.3節（schedulesテーブル定義）

---

## 将来の拡張方針

### 半自動化の検討

**PoC実装**:
- **キャプションからURLを抽出するスクリプト**（推奨）:
  - **目的**: 人間がコピーしたInstagram投稿のキャプションテキストから、スケジュールURLを抽出する補助ツール
  - **入力**: テキストファイル（人間がコピーしたキャプション全文やメモ）または事前に保存したHTML片
  - **処理**: 
    - 正規表現でURLを抽出し、`https://` から始まるURLを一覧に整形
    - Googleドライブ、自治体サイト等のURLパターンを認識して分類（`typeGuess`）
  - **出力**: JSON形式（例: `[{ url: string, typeGuess: string }]`）
    - `url`: 抽出されたURL
    - `typeGuess`: URLの種類の推測（`"google_drive"`, `"city_site"`, `"instagram_post"`, `"other"` など）
  - **位置づけ**: 
    - **本番運用には組み込まず、「ローカルで人が使う補助ツール」扱い**とする
    - 抽出したURLは、人間が確認・検証してから `schedules` テーブルに登録する
    - 実装場所: `apps/scripts/instagram-caption-url-extractor.ts`（仮名）
  - **限界**:
    - キャプション内にURLが含まれていない場合は抽出不可
    - URLの種類の推測は簡易的なもので、100%正確ではない
    - 複数のURLが含まれている場合、どれがスケジュールURLかは人間が判断する必要がある
- **詳細ページ経由のスクレイピング**:
  - **調査結果により、詳細ページにInstagramリンクが含まれていないことが判明**
  - 現時点では実装不要
  - 将来的に名古屋市サイトが更新され、Instagramリンクが追加された場合に検討

**自動化の範囲**（2025-01-22更新）:
- **自動化可能**: 
  - ~~InstagramアカウントURLの取得（詳細ページにリンクがある場合）~~ → **調査結果により、詳細ページにリンクがないことが判明**
  - キャプション内URLの抽出（投稿形式が統一されている場合）→ **PoCとして検討**
- **人手が必要**（確定）:
  - InstagramアカウントURLの特定（名古屋市サイトにリンクがないため）
  - スケジュールURLの確認・検証（自動抽出したURLが正しいか確認）
  - 投稿形式がバラバラな場合の対応

### 運用改善

**定期更新フロー**:
- **月1回程度の確認・更新手順**:
  1. 各施設のInstagramアカウントを確認
  2. 新しい月間スケジュールの投稿を確認
  3. スケジュールURLを `schedules.instagram_post_url` に登録
  4. 更新日時を記録（将来的に `last_updated_at` カラムを追加予定）

**監視・アラート**:
- **埋め込み失敗時の通知**:
  - oEmbed APIの呼び出しが失敗した場合、エラーログを記録
  - 連続エラー発生時は通知（将来的に実装）
- **データ整合性チェック**:
  - `instagram_post_url` が無効なURLになっていないか定期チェック
  - 古い月のスケジュールをアーカイブ（`status = 'archived'`）

---

## 制約・リスク

### 既知の制約

1. **Instagramアカウントの特定が困難**
   - 名古屋市サイトにInstagramリンクが含まれていない
   - 手動で検索する必要があり、工数がかかる
   - すべての施設にInstagramアカウントがあるとは限らない

2. **投稿形式の統一性がない**
   - 各施設で投稿形式が異なる可能性が高い
   - 自動化が困難

3. **更新頻度の管理**
   - 月間スケジュールは毎月更新される
   - 手動更新の場合、更新漏れのリスクがある

### リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| Instagramアカウントが見つからない | 中 | 手動で検索し、見つからない場合はスキップ（MVPでは部分的な対応で可） |
| スケジュールURLの更新漏れ | 中 | 定期更新フローを確立し、月1回程度確認 |
| 投稿URLが無効になる | 低 | フォールバック表示（画像URL）を実装 |
| oEmbed APIのレート制限 | 低 | キャッシュを活用し、必要に応じてアクセストークンを取得 |

---

## 参考資料

- [02 設計資料](../02-design.md) - schedulesテーブル定義
- [03 API 仕様](../03-api.md) - Instagram Embed API仕様
- [04 開発ガイド](../04-development.md) - スクレイピングガイドライン

