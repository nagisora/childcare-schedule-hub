# 03 決定事項・採用方針

## 決定日

2025-01-22（初版作成）
2025-01-22（調査結果を反映して更新）

## MVPでの方針

### 採用した技術選択肢

**調査結果に基づく判断**（2025-01-22更新）:
- 名古屋市サイトの一覧ページにはInstagramリンクが含まれていない
- **詳細ページにもInstagramリンクが含まれていない**（サンプル3件を確認済み）
- 現在、すべての施設で `instagram_url` は `null`

**採用方針**:
1. **InstagramアカウントURLの取得**: 手動調査・登録（詳細ページの確認後に判断）
2. **スケジュールURLの登録**: 手動登録
3. **表示方法**: Instagram公式API（oEmbed）

### 実装方針

**InstagramアカウントURLの取得**:
- **MVPでは手動調査・登録を基本とする**（確定）
  - 施設名や住所から検索してInstagramアカウントを特定
  - 見つかったアカウントを `facilities.instagram_url` に手動登録
  - すべての施設で埋まっていなくてもOK（部分的な対応で可）
- **詳細ページの確認結果**（2025-01-22）
  - サンプル3件の詳細ページを確認した結果、Instagramリンクが含まれていないことを確認
  - **結論**: スクレイピングスクリプトの拡張は現時点では不要
  - 将来的に名古屋市サイトが更新され、Instagramリンクが追加される可能性はあるが、優先度は低い

**スケジュールURLの登録**:
- **手動登録を基本とする**
  - 人がInstagramアカウントを確認し、スケジュールURLを `schedules.instagram_post_url` に登録
  - すべての施設で埋まっていなくてもOK（MVPでは部分的な対応で可）
  - 投稿形式がバラバラでも柔軟に対応可能

**表示方法**:
- **Instagram公式API（oEmbed）を使用**
  - 投稿URLが登録されている場合のみ埋め込み表示
  - 投稿URLが無効な場合は、画像URL（`schedules.image_url`）をフォールバック表示
  - [03 API 仕様](../03-api.md) 3.1節（Instagram Embed API）に準拠

---

## schedulesテーブルの更新ポリシー

### データ投入方法

**手動入力フロー**:
- **Supabase Studio での操作**:
  1. Supabase プロジェクトのダッシュボードにアクセス
  2. Table Editor > `schedules` テーブルを開く
  3. **Insert** > **Insert row** をクリック
  4. 以下の項目を入力:
     - `facility_id`: 対象施設のUUID
     - `instagram_post_url`: Instagram投稿URL（例: `https://www.instagram.com/p/...`）
     - `published_month`: 対象月の1日（例: `2025-01-01`）
     - `status`: `published`
  5. **Save** をクリック
- **SQLでの操作**:
  ```sql
  INSERT INTO schedules (facility_id, instagram_post_url, published_month, status)
  VALUES (
    'facility-uuid-here',
    'https://www.instagram.com/p/...',
    '2025-01-01',
    'published'
  );
  ```

**更新頻度**:
- **月1回程度を目安とする**
  - 各施設の月間スケジュールが更新されるタイミングに合わせて更新
  - すべての施設で同時に更新する必要はなく、更新された施設のみ更新すればOK

**データ品質管理**:
- **重複チェック**: `(facility_id, published_month)` の組み合わせで一意制約があるため、重複登録は不可
- **バリデーション**: 
  - `instagram_post_url` は有効なInstagram投稿URLであることを確認
  - `published_month` は月の1日であることを確認（例: `2025-01-01`）

### データ構造

**schedulesテーブルの利用方針**:
- `instagram_post_url`: Instagram投稿URLを保存。oEmbed APIで埋め込みHTMLを取得する際に使用
- `image_url`: スケジュール画像のURL（将来拡張用）。現在は未使用
- `embed_html`: oEmbed APIで取得した埋め込みHTMLをキャッシュ（将来拡張用）。現在は未使用
- `published_month`: 対象月の1日で管理。`UNIQUE (facility_id, published_month)` 制約により重複を防止

**参考**: [02 設計資料](../02-design.md) 3.3節（schedulesテーブル定義）

---

## 将来の拡張方針

### 半自動化の検討

**PoC実装**:
- **キャプションからURLを抽出するスクリプト**（推奨）:
  - **目的**: 人間がコピーしたInstagram投稿のキャプションテキストから、スケジュールURLを抽出する補助ツール
  - **入力**: テキストファイル（人間がコピーしたキャプション全文やメモ）または事前に保存したHTML片
  - **処理**: 
    - 正規表現でURLを抽出し、`https://` から始まるURLを一覧に整形
    - Googleドライブ、自治体サイト等のURLパターンを認識して分類（`typeGuess`）
  - **出力**: JSON形式（例: `[{ url: string, typeGuess: string }]`）
    - `url`: 抽出されたURL
    - `typeGuess`: URLの種類の推測（`"google_drive"`, `"city_site"`, `"instagram_post"`, `"other"` など）
  - **位置づけ**: 
    - **本番運用には組み込まず、「ローカルで人が使う補助ツール」扱い**とする
    - 抽出したURLは、人間が確認・検証してから `schedules` テーブルに登録する
    - 実装場所: `apps/scripts/instagram-caption-url-extractor.ts`（仮名）
  - **限界**:
    - キャプション内にURLが含まれていない場合は抽出不可
    - URLの種類の推測は簡易的なもので、100%正確ではない
    - 複数のURLが含まれている場合、どれがスケジュールURLかは人間が判断する必要がある
- **詳細ページ経由のスクレイピング**:
  - **調査結果により、詳細ページにInstagramリンクが含まれていないことが判明**
  - 現時点では実装不要
  - 将来的に名古屋市サイトが更新され、Instagramリンクが追加された場合に検討

**自動化の範囲**（2025-01-22更新）:
- **自動化可能**: 
  - ~~InstagramアカウントURLの取得（詳細ページにリンクがある場合）~~ → **調査結果により、詳細ページにリンクがないことが判明**
  - キャプション内URLの抽出（投稿形式が統一されている場合）→ **PoCとして検討**
- **人手が必要**（確定）:
  - InstagramアカウントURLの特定（名古屋市サイトにリンクがないため）
  - スケジュールURLの確認・検証（自動抽出したURLが正しいか確認）
  - 投稿形式がバラバラな場合の対応

### 運用改善

**定期更新フロー**:
- **月1回程度の確認・更新手順**:
  1. 各施設のInstagramアカウントを確認
  2. 新しい月間スケジュールの投稿を確認
  3. スケジュールURLを `schedules.instagram_post_url` に登録
  4. 更新日時を記録（将来的に `last_updated_at` カラムを追加予定）

**監視・アラート**:
- **埋め込み失敗時の通知**:
  - oEmbed APIの呼び出しが失敗した場合、エラーログを記録
  - 連続エラー発生時は通知（将来的に実装）
- **データ整合性チェック**:
  - `instagram_post_url` が無効なURLになっていないか定期チェック
  - 古い月のスケジュールをアーカイブ（`status = 'archived'`）

---

## フェーズ9以降: InstagramアカウントURL検索フローの方針（2025-12-09更新）

### 背景

- フェーズ9「InstagramアカウントURLの全面カバー」では、**全施設の `facilities.instagram_url` をできるだけ自動＋半自動で埋める** ことが目的。
- 従来は「ブラウザでGoogle検索を開き、人間 or AI が画面を見て判断する」運用のみを想定していたが、
  - ブラウザ操作は時間がかかる
  - AIが検索結果のトップにあるURLを見逃すケースがある
  という課題があり、**検索APIを用いた構造化データの取得**を検討した。

### 採用方針（検索バックエンド）

- **1. Google Custom Search API を第1候補として採用する**
  - 理由:
    - 公式APIであり、HTMLスクレイピング系ライブラリに比べて**長期運用の安定性が高い**
    - Google検索の精度が高く、日本のローカルな施設名・地名との相性が良い
    - 無料枠（1日100クエリ）があり、フェーズ9で想定している「月あたり数十件〜数百件」レベルであれば**完全に無料枠内で運用可能**
    - Next.js（本プロジェクト）のサーバーサイドから `fetch` で直接叩けるため、**別ランタイム（Pythonなど）を増やさずに済む**

- **2. Serper.dev は将来の拡張候補として保持**
  - 位置づけ:
    - Google検索結果を安価に利用できる有料APIとして、**無料枠を超える or 高頻度利用が必要になった場合のオプション**とする
    - 現時点では、フェーズ9のスコープ（クエリ数が少ない）では **Google Custom Search API の無料枠で十分** と判断

- **3. DuckDuckGo Search (Pythonライブラリ) は本プロジェクトでは採用しない**
  - 理由:
    - DuckDuckGo公式APIではなく、検索結果HTMLをスクレイピングする**非公式ライブラリ**である
    - 仕様変更・ブロックにより**突然動かなくなるリスク**があり、長期運用には向かない
    - 別途Python実行環境を用意する必要があり、Next.js単体で完結しない
  - 位置づけ:
    - `docs/instagram-integration/ai-comparisons/search-api-comparison.md` および  
      `duckduckgo-search-implementation-example.md` に**比較資料・実装例としては残す**が、
      少なくともフェーズ9の実装では **採用しない前提** とする

### 想定する実装イメージ（高レベル）

- Next.js の **サーバーサイドAPI（Route Handler / API Route）** から Google Custom Search API を呼び出す:
  - 環境変数（サーバー専用）:
    - `GOOGLE_CSE_API_KEY`
    - `GOOGLE_CSE_CX`（Programmable Search Engine の識別子）
  - 代表的な検索クエリ例:
    - `site:instagram.com "<施設名>" "<区名>" 子育て`
  - APIレスポンスから:
    - `items[].link`（InstagramプロフィールURL候補）
    - `items[].snippet`（施設名・エリア情報の確認用テキスト）
    を取得し、**ルールベースで「公式と思われる候補」を1件に絞る**。

- 既存の手動フローとの関係:
  - `docs/instagram-integration/05-instagram-account-search.md` にある「ブラウザでGoogle検索を開く手順」は、
    **フォールバック用の手動手順**として維持する。
  - 今後、Google Custom Search API ベースのフローが十分に安定した段階で、
    同指示書を「検索API版の手順」に差し替えることを検討する。

### 検索クエリ設計と判定ルール（フェーズ9実装案、2025-12-13追加）

#### 検索クエリの優先順位

Google Custom Search API を使用する場合、以下の順序でクエリを試行する（最初に候補が見つかった時点で次へ進む）：

1. **最優先**: `site:instagram.com "<施設名>" "<区名>" 子育て`
   - 例: `site:instagram.com "あおぞらわらばぁ～" "東区" 子育て`
   - Instagram内を直接検索し、区名と「子育て」キーワードで絞り込む

2. **第2優先**: `site:instagram.com "<施設名>" "<区名>"`
   - 例: `site:instagram.com "あおぞらわらばぁ～" "東区"`
   - 「子育て」が含まれない場合でも、施設名と区名で検索

3. **第3優先**: `site:instagram.com "<施設名>" 名古屋`
   - 例: `site:instagram.com "あおぞらわらばぁ～" 名古屋`
   - 区名がヒットしない場合のフォールバック

4. **第4優先**: `site:instagram.com "<施設名>"`
   - 例: `site:instagram.com "あおぞらわらばぁ～"`
   - 最小限のクエリ（誤検出リスクが上がるため優先度は低め）

**注意**: 
- すべてのクエリで `site:instagram.com` を使用し、Instagram以外のドメインを除外する
- 施設名や区名に特殊文字（括弧、記号など）が含まれる場合は、エスケープ処理が必要な場合がある

#### 検索結果からの公式判定ルール

Google Custom Search API のレスポンス `items[]` から、上位N件（例: 上位5件）を確認し、以下の観点でスコアリングして「公式と思われる候補」を1件に絞る：

**スコアリング観点**（各観点は独立して評価）:
1. **施設名の一致度**
   - `items[].title` または `items[].snippet` に施設名が完全一致または部分一致する: +3点
   - 類似名称（ひらがな/カタカナ/漢字の違いのみ）: +2点
   - 施設名が見当たらない: 0点

2. **エリア情報の一致**
   - `items[].snippet` に区名（例: 「東区」）が含まれる: +2点
   - 「名古屋」が含まれる（区名がない場合）: +1点
   - エリア情報なし: 0点

3. **子育て拠点関連のワード**
   - 「子育て応援拠点」「地域子育て支援拠点」「子育て」などのワードが含まれる: +2点
   - 関連ワードなし: 0点

4. **プロフィールURL形式の確認**
   - `items[].link` が `https://www.instagram.com/<username>/` 形式（プロフィールURL）: +1点
   - 投稿URL（`/p/` `/reel/` など）や共有リンク（`?igsh=` 付き）: -10点（除外）

**判定基準**:
- 合計スコアが **5点以上** の候補を「公式と思われる候補」として採用する
- 複数の候補が5点以上の場合は、**スコアが最も高い候補を1件**に絞る
- 同点の場合は、`items[]` の順序（Google検索の信頼度順）を優先する

#### 除外すべきパターン

以下のURLは、スコアに関係なく除外する（「公式」として採用しない）：

1. **投稿URL・リールURLなど**
   - `/p/` （投稿）
   - `/reel/` （リール）
   - `/tv/` （IGTV）
   - `/stories/` （ストーリーズ）

2. **共有リンク（クエリパラメータ付き）**
   - `?igsh=` や `?utm_source=` などのクエリパラメータが含まれるURL

3. **Instagram以外のドメイン**
   - `site:instagram.com` を使っているため通常は発生しないが、念のため確認

#### あきらめ条件（未特定の扱い）

以下の条件を**すべて**満たす場合、その施設については **「未特定（理由付き）」** として扱う：

- 上記の優先順位で4種類のクエリを試しても、`items[]` が空（0件）である
- または、`items[]` に含まれる候補がすべて除外パターンに該当する
- または、すべての候補のスコアが5点未満である

**未特定の場合の記録方法**:
- `facilities.instagram_url` は更新せず、`NULL` のままにする
- dev-sessions や Runbook に「未特定」として以下を記録:
  - 施設名・区名
  - 試したクエリパターン
  - 検索結果の件数（0件 or 低スコアの候補のみ）
  - 判断理由（例: 「候補0件」「上位3件すべてが個人アカウントで施設との関連性が確認できず」）

### 関連ドキュメント

- 検索APIの比較・検証方針:
  - `docs/instagram-integration/ai-comparisons/search-api-comparison.md`
- 実装例（参考）:
  - `docs/instagram-integration/ai-comparisons/duckduckgo-search-implementation-example.md`
- 手動検索手順（現行の正式手順）:
  - `docs/instagram-integration/05-instagram-account-search.md`

---

## 制約・リスク

### 既知の制約

1. **Instagramアカウントの特定が困難**
   - 名古屋市サイトにInstagramリンクが含まれていない
   - 手動で検索する必要があり、工数がかかる
   - すべての施設にInstagramアカウントがあるとは限らない

2. **投稿形式の統一性がない**
   - 各施設で投稿形式が異なる可能性が高い
   - 自動化が困難

3. **更新頻度の管理**
   - 月間スケジュールは毎月更新される
   - 手動更新の場合、更新漏れのリスクがある

### リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| Instagramアカウントが見つからない | 中 | 手動で検索し、見つからない場合はスキップ（MVPでは部分的な対応で可） |
| スケジュールURLの更新漏れ | 中 | 定期更新フローを確立し、月1回程度確認 |
| 投稿URLが無効になる | 低 | フォールバック表示（画像URL）を実装 |
| oEmbed APIのレート制限 | 低 | キャッシュを活用し、必要に応じてアクセストークンを取得 |

---

## 参考資料

- [02 設計資料](../02-design.md) - schedulesテーブル定義
- [03 API 仕様](../03-api.md) - Instagram Embed API仕様
- [04 開発ガイド](../04-development.md) - スクレイピングガイドライン

