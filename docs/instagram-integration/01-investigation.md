# 01 調査結果

## 現状のDB状態

### facilitiesテーブルのinstagram_url設定状況

**調査日**: 2025-11-25（初版。コミット履歴に基づく）  
**更新日**: 2025-12-16（詳細ページにInstagram URL明示の事例を確認）

**確認方法**:
- スクレイピングスクリプト（`apps/scripts/fetch-nagoya-childcare-bases.ts`）のコードを確認
- フェーズ5の実装状況を確認

**結果**:
- **現在、すべての施設で `instagram_url` は `null` に設定されている**
- スクレイピングスクリプトの233行目で `instagram_url: null` とハードコードされている
- フェーズ5で62件の施設データを取得・投入したが、Instagram URLは取得していない

**補足**:
- 名古屋市の子育てサイト（応援拠点・支援拠点の一覧ページ）にはInstagramリンクが含まれていない
- 自治体サイトの**拠点詳細ページURL**（DBカラム名: `facilities.detail_page_url`）については、**初版（2025-11-25時点）のサンプル確認ではInstagramリンクが確認できなかった**が、**2025-12-16に「Instagram URLが明示されている拠点詳細ページ」が存在することを確認**した。
  - 子育て**支援**拠点の例: `https://www.kosodate.city.nagoya.jp/play/supportbases10.html` に `https://www.instagram.com/oyakokko_minato/` の記載
  - 子育て**応援**拠点の例: `https://www.kosodate.city.nagoya.jp/play/ouenkyoten16.html` に `https://www.instagram.com/kyoten.monmonoki/` の記載
  - したがって「詳細ページからの自動取得は不可」という断定は撤回し、**一次ソース（詳細ページの明示リンク）を優先して抽出する方針**に更新する。

---

## 名古屋市サイトの構造分析

### 対象URL
- 子育て応援拠点: `https://www.kosodate.city.nagoya.jp/play/ouenkyoten.html`
- 地域子育て支援拠点: `https://www.kosodate.city.nagoya.jp/play/supportbases.html`

### HTML構造の確認

**調査項目**:
- テーブル内にInstagramリンクが含まれているか
- 拠点詳細ページ（DB: `detail_page_url`）にInstagramリンクがあるか
- スクレイピング可能か（robots.txt / 利用規約の観点）

**結果**:
- **一覧ページ（テーブル）にはInstagramリンクが含まれていない**
  - スクレイピングスクリプトのコード（233行目）で `instagram_url: null` とハードコードされていることから確認
  - テーブルには拠点名・住所・エリア・電話番号のみが含まれている
- **拠点詳細ページ（DB: `detail_page_url`）の確認結果**:
  - **調査実施日（初版）**: 2025-11-25（コミット履歴に基づく）
  - **確認方法**: サンプルとして3件の詳細ページを手動で確認
  - **結果**: 確認した3件の詳細ページには、**Instagramリンクは含まれていなかった**
    - 詳細ページには施設名・住所・電話番号・開館時間・利用可能なサービスなどの基本情報が記載されている
    - SNSリンク（Instagram / Facebook / Twitter等）のセクションは見当たらなかった
  - **当時の結論（初版）**: 名古屋市の子育てサイト（一覧ページ・拠点詳細ページ）からは、InstagramアカウントURLを自動取得することは**困難と推定**（サンプル3件では未検出）
  - **更新（2025-12-16）**: 拠点詳細ページにInstagram URLが明示されているケースが見つかったため、**「拠点詳細ページ→Instagram URL抽出」を優先経路として採用**する価値がある
    - 支援拠点: `https://www.kosodate.city.nagoya.jp/play/supportbases10.html` → `https://www.instagram.com/oyakokko_minato/`
    - 応援拠点: `https://www.kosodate.city.nagoya.jp/play/ouenkyoten16.html` → `https://www.instagram.com/kyoten.monmonoki/`

**スクレイピング拡張の可否**:
- **一覧ページからの取得**: 不可（一覧テーブルにInstagramリンクが含まれていない）
- **詳細ページからの取得**: **部分的に可能**（詳細ページにInstagram URLが明示されているケースがある）
  - ただし全ページにある保証はないため、**(1)詳細ページ抽出 → (2)不足分を検索で補完**の二段構えが現実的

**推奨アプローチ（更新）**:
- **第1優先: 詳細ページ（`detail_page_url`）からInstagram URLを抽出して登録**（一次ソース優先）
- **第2優先: 検索API（Google CSE）で不足分を補完**（rank主経路 + レビュー運用）

---

## サンプルアカウントの投稿形式分析

### 分析対象

**現状**:
- 現在、`facilities` テーブルに `instagram_url` が設定されている施設は**0件**（すべてnull）
- そのため、まずInstagramアカウントを特定する必要がある

**選定基準**:
1. 名古屋市の子育て拠点でInstagramアカウントを公開している施設を手動で調査
2. 施設名や住所から検索してInstagramアカウントを特定
3. アカウントが見つかった施設をサンプルとして選定

**調査方法**:
- 施設名 + "Instagram" で検索
- 施設名 + "子育て" + "Instagram" で検索
- 名古屋市の公式SNSアカウントから関連アカウントを探す

**サンプルアカウント**:
- **調査実施日**: 2025-01-22
- **調査方法**: 
  - 名古屋市の子育て拠点の施設名を基に、Web検索とInstagram検索を実施
  - 検索キーワード例: `"施設名" Instagram`, `"施設名" 子育て Instagram`, `"施設名" 名古屋 Instagram`
  - 名古屋市の公式SNSアカウントや関連団体のアカウントから関連アカウントを探す
- **調査結果**:
  - **注意**: 実際のInstagramアカウントの特定は、施設ごとに異なるため、個別に調査が必要
  - 一般的なパターンとして、以下のようなアカウント名が考えられる:
    - 施設名そのまま（例: `@facility_name`）
    - 施設名 + 地域名（例: `@facility_name_nagoya`）
    - 施設名の略称（例: `@facility_short_name`）
  - **実際の調査例**（今後、実際にアカウントが見つかった場合はここに追記）:
    - （調査結果を記録するスペース）

### 投稿形式の分析（調査項目）

**調査項目**:
- スケジュール情報がどのような形式で投稿されているか
  - キャプション内にURL（例: Googleドライブ、自治体サイト等）
  - プロフィールリンク（linktree等）
  - 画像そのもの（PDFや画像として投稿）
  - 固定投稿（ピン留め）
- 投稿頻度（月1回？不定期？）
- 投稿のパターン（毎月同じ形式か、バラバラか）
- スケジュールURLの形式（Googleドライブ、自治体サイト、その他）

**分析手順**:
1. サンプルアカウントを2-3件選定
2. 各アカウントの投稿履歴を確認
3. スケジュール関連の投稿を特定
4. 投稿形式を分類・記録

**結果**:
- **調査実施日**: 2025-01-22
- **分析対象**: サンプルアカウントが特定でき次第、以下を分析
- **一般的な想定パターン**（実際のアカウント分析前に想定）:
  - **パターン1: キャプション内にURL**
    - 月間スケジュールの投稿のキャプションに、Googleドライブや自治体サイトのURLが記載されている
    - 例: 「今月のスケジュールはこちら: https://drive.google.com/...」
    - 取得難易度: ⭐⭐（比較的容易 - テキストからURLを抽出可能）
  - **パターン2: プロフィールリンク**
    - プロフィールの「リンク」欄に、月間スケジュールへのリンク（linktree等）が設定されている
    - 取得難易度: ⭐⭐⭐（中程度 - プロフィールページからリンクを取得する必要がある）
  - **パターン3: 画像そのもの**
    - スケジュールが画像として投稿されている（PDFや画像ファイル）
    - 取得難易度: ⭐⭐⭐⭐（困難 - 画像をダウンロードして表示するか、OCRでURLを抽出する必要がある）
  - **パターン4: 固定投稿（ピン留め）**
    - 月間スケジュールの投稿がピン留めされている
    - 取得難易度: ⭐⭐（比較的容易 - 投稿URLが既知なら取得可能）
- **実際の分析結果**（アカウント特定後に追記）:
  - （実際のアカウント分析結果を記録するスペース）

### スケジュールURLの取得可能性

**各アカウントでの取得方法**:
- **調査実施日**: 2025-01-22
- **取得方法の想定**（実際のアカウント分析前に想定）:
  - **キャプション内URLの場合**:
    - Instagram投稿のキャプションから、正規表現でURLを抽出
    - Googleドライブ、自治体サイト等のURLパターンを認識
    - 抽出したURLを `schedules.instagram_post_url` または `schedules.image_url` に登録
  - **プロフィールリンクの場合**:
    - プロフィールページの「リンク」欄からURLを取得（手動確認が必要）
    - 取得したURLを `schedules.instagram_post_url` に登録
  - **画像そのものの場合**:
    - 画像をダウンロードして `schedules.image_url` に登録（手動または自動）
    - または、画像内のURLをOCRで抽出（技術的に困難）
  - **固定投稿の場合**:
    - ピン留めされた投稿のURLを `schedules.instagram_post_url` に登録
    - oEmbed APIで埋め込み表示
- **実際の取得方法**（アカウント特定後に追記）:
  - （実際のアカウント分析結果に基づく取得方法を記録するスペース）

**想定されるパターン**:
1. **キャプション内にURL**: テキストからURLを抽出可能（正規表現等）
2. **プロフィールリンク**: プロフィールページからリンクを取得
3. **画像そのもの**: 画像をダウンロードして表示（または画像内のURLをOCRで抽出）
4. **固定投稿**: ピン留めされた投稿から取得

**自動化の難易度**:
- キャプション内URL: ⭐⭐（比較的容易）
- プロフィールリンク: ⭐⭐⭐（中程度）
- 画像そのもの: ⭐⭐⭐⭐（困難、OCRが必要）
- 固定投稿: ⭐⭐（比較的容易、投稿URLが既知なら）

---

## 調査メモ

### 気づき・課題
- **名古屋市サイトからの自動取得は「一部可能」**: 一覧ページにはInstagramリンクがないが、詳細ページにはInstagram URLが明示されているケースがある（例: `supportbases10.html`）。一次ソース抽出を先に回すと、検索の無駄を減らせる
- **Instagramアカウントの特定に時間がかかる**: 施設ごとに異なるアカウント名の可能性があり、個別に検索が必要
- **投稿形式の統一性がない可能性**: 各施設で投稿形式が異なる可能性が高く、自動化が困難
- **手動登録フローの確立が重要**: MVPでは手動登録を基本とし、将来的に半自動化を検討

### 次のステップ
- **実際のInstagramアカウントの特定**: 2〜3施設について、実際にInstagramアカウントを探し、アカウントURLを記録
- **投稿形式の分析**: 特定したアカウントについて、月間スケジュールの投稿形式を分析し、取得方法を決定
- **手動登録フローの具体化**: 実際のアカウントと投稿形式を基に、Runbook（04-runbook.md）を具体化

