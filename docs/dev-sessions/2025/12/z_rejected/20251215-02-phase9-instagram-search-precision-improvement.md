# チェックリスト式実装計画書: 2025-12-15

> **重要（AI作業時）**: このファイルは `date +%Y%m%d` の結果（`20251215`）に基づいて作成している。  
> ルール: `docs/dev-sessions/README.md` / `docs/05-00-development-phases.md#dev-sessions-date`

## セッション概要とゴール

### 概要

- 一言サマリ: フェーズ9のInstagram URL登録CLI（rank戦略）の検索精度を、実測データ拡大とクエリ改善で引き上げる
- 対応フェーズ: フェーズ9
- セッション種別: 検証 + 実装 + ドキュメント整備
- 影響範囲: `apps/scripts`（CLI実行での検証）/ `apps/web/lib/instagram-search.ts`（クエリ生成）/ `docs/dev-sessions` / `docs/05-09-instagram-account-url-coverage.md`
- 日付: 2025-12-15
- 想定所要時間: 60〜120 分（実測件数次第。途中で分割してOK）

### ゴール

> **チェックの付け方（完了条件）**:
> - 完了条件は **Markdownのチェックリスト**（`- [ ]`）で記述する（開始時点では未チェック）
> - セッションの最後に、満たした完了条件を `- [x]` に更新する（ゴール達成のセルフチェック）

- **ゴール**: rank戦略の検索精度を、10〜20件の実測で定量化し、クエリ改善の効果を比較できる状態にする
  - 完了条件:
    - [ ] 10〜20件の施設について、候補数（0/1/複数）・自動採用可否・未特定理由・候補品質（正候補が含まれるか）を記録している
    - [ ] `apps/web/lib/instagram-search.ts` の rank戦略クエリを改善し、改善前後の結果を同一条件で比較している
    - [ ] 結果と分析を本dev-sessionに記録し、`docs/05-09-instagram-account-url-coverage.md`（タスク5/進捗）へ進捗反映している
  - 補足:
    - シークレット（APIキー/トークン）は絶対に表示・ログ出力しない
    - 実測は原則 DRY-RUN。DB更新（`--apply --yes`）は本セッションのスコープ外（必要なら別セッションで）

### 関連ドキュメント

- 参照: `docs/05-09-instagram-account-url-coverage.md`（フェーズ9正本、タスク5/進捗）
- 参照: `docs/dev-sessions/2025/12/20251215-01-phase9-instagram-auto-adopt-review.md`（直前セッション。auto-adopt導入済み・rankクエリに `子育て拠点`/`子育て` 追加済み）
- 参照: `docs/04-development.md`（9.5.3: CLI手順）
- 参照: `apps/scripts/instagram-semi-auto-registration.ts`（CLI実装。`--auto-adopt` / reviewログ出力）
- 参照: `apps/web/lib/instagram-search.ts`（検索クエリ生成ロジック）

## 前提・合意事項（事前議論・壁打ちメモ）

- 今日のセッションで前提とする方針:
  - `--auto-adopt` は **opt-in**（安全装置）であり、候補1件のみ自動採用、複数候補は未特定として残す
  - rank戦略には既に `子育て拠点` / `子育て` が追加されている（効果は未測定）
  - 実測結果は後から分析できるよう、施設ごとに構造化して記録する（最低限: 施設名 / 候補数 / reason / 候補の妥当性）
- 議論概要:
  - 東区3件では、候補1件×2は自動採用可能、候補複数×1は未特定（安全側）という挙動が確認できた
  - 次の課題は「区を広げた実測」「rank戦略のクエリ改善（例: `名古屋市` の扱い）」「改善効果の比較」
- 保留中の論点 / 今回は触らないと決めたこと:
  - 再検索抑制キャッシュ（facilityId+query+results）実装（効率化/コスト削減。別セッション）
  - Runbook整備とデータ品質チェック（フェーズ9タスク6。別セッション）

---

## 実装チェックリスト（本セッションにおける）

### 1. 作業タスク & プロンプト設計（実装・ドキュメント更新）

- [ ] タスク1: 実測対象（10〜20件）を選定し、改善前（現状）のrank結果をDRY-RUNで記録する
  - 完了条件: 対象区を決め、10〜20施設分の「候補数/自動採用可否/未特定理由/候補品質」を本ファイルに記録できている
  - **実行プロンプト案**:
    ```
    フェーズ9のInstagram URL登録CLI（rank戦略）の検索精度を実測で把握したいです。

    - 参照ファイル:
      - docs/05-09-instagram-account-url-coverage.md
      - docs/04-development.md（9.5.3）
      - apps/scripts/instagram-semi-auto-registration.ts
      - apps/scripts/logs/instagram-review-*.md（出力例）
    - やりたいこと:
      - 「東区以外」で未登録施設が10〜20件程度ある区を選定する（SQLで ward別の未登録数を集計して決める）
      - DRY-RUNで `--ward=<区名> --strategy=rank --auto-adopt` を実行し、最新の reviewログ（md）を読み取り、施設ごとに以下を記録する:
        - 施設名
        - 候補数（0 / 1 / 2以上）
        - 自動採用可否（候補1件なら可、複数候補なら不可）
        - 未特定の場合の reason（例: auto_adopt_blocked_multiple_candidates / no_candidates）
        - 候補品質（正しい候補が含まれているか、誤検出が多いか）
    - 制約・注意点:
      - シークレットは表示・ログ出力しない
      - DB更新はしない（--apply は付けない）
    ```

- [ ] タスク2: rank戦略のクエリ改善を実装し、同一条件で再実測して効果を比較する
  - 完了条件: `apps/web/lib/instagram-search.ts` の `generateSearchQueries()` を更新し、タスク1と同じ区・同程度件数で改善後の結果を再取得して比較できている
  - **実行プロンプト案**:
    ```
    フェーズ9のrank戦略の検索クエリ生成（generateSearchQueries）を改善し、精度向上を狙いたいです。

    - 参照ファイル:
      - apps/web/lib/instagram-search.ts（generateSearchQueries）
      - apps/scripts/instagram-semi-auto-registration.ts（rank戦略が使う検索）
      - docs/dev-sessions/2025/12/20251215-02-phase9-instagram-search-precision-improvement.md（本ファイル、改善前の実測結果）
    - やりたいこと:
      - `名古屋市` の扱いを見直し、区名と組み合わせたクエリの優先度/パターンを改善する
      - 短い施設名（例: 1〜2語）で誤検出が増えるケースに対し、追加語（例: 保育園/子育て支援/ひろば 等）やクエリ順序の工夫で精度を上げる
      - 変更は段階的に行い、変更内容と意図をコメントで残す
      - 変更後に、タスク1と同じ ward でDRY-RUNを再実行し、候補数分布（0/1/複数）と「正候補が含まれる率」を比較する
    - 制約・注意点:
      - シークレットは表示・ログ出力しない
      - 既存の検索戦略切替（score|rank）を壊さない
    ```

- [ ] タスク3: 結果を整理し、正本ドキュメントへ進捗を反映する
  - 完了条件: 本dev-sessionに「実測表」「改善点」「改善前後比較」「今後の方針」を記録し、`docs/05-09-instagram-account-url-coverage.md` のタスク5（または関連節）に進捗リンクを追記している
  - **実行プロンプト案**:
    ```
    実測と改善を行ったので、結果を整理してドキュメントを更新してください。

    - 対象ファイル:
      - docs/dev-sessions/2025/12/20251215-02-phase9-instagram-search-precision-improvement.md
      - docs/05-09-instagram-account-url-coverage.md（進捗チェックリスト / タスク5）
    - やりたいこと:
      - 実測結果を「成功/失敗パターン」に分類し、代表例と改善案をまとめる
      - 改善前後で数値（0/1/複数の割合など）を比較し、差分を要約する
      - フェーズ9正本の該当箇所に、今回のdev-sessionリンクと進捗メモを追記する
    - 制約・注意点:
      - シークレットは書かない
    ```

### 2. 検証・テスト（確認方法）

- [ ] 確認1: 実測（改善前）のDRY-RUNが完走し、reviewログから10〜20件分の結果が読み取れる
      - 期待結果: `apps/scripts/logs/instagram-review-*.md` に、対象区の施設が列挙され、候補/理由が確認できる
- [ ] 確認2: クエリ改善後に同一条件でDRY-RUNを再実行でき、改善前後の比較が可能
      - 期待結果: 0/1/複数候補の分布や、正候補が含まれる率が比較できる（悪化していないこと）

---

## 実施ログ

- スタート: TODO: HH:MM
- メモ:
  - TODO: 対象区
  - TODO: 実測ログ（改善前）ファイル名
  - TODO: 実測ログ（改善後）ファイル名

## 結果とふりかえり

- 完了できたタスク:
  - [ ] タスク1
  - [ ] タスク2
  - [ ] タスク3
- 未完了タスク / 想定外だったこと:
  - TODO:
- 学び・次回改善したいこと:
  - TODO:

## 次回に持ち越すタスク

> **このリストが持ち越しの正本（最新）**。前回までのセッションは「持ち越し済み」でクローズし、ここだけ見れば良い状態にする。

- [ ] 再検索抑制キャッシュ（facilityId+query+results）の設計・実装
  - 今回やらない理由: 効率化/コスト削減が主目的で、精度改善の実測・改善が先
  - 次回の着手条件: 精度改善で触るクエリがある程度固まった後
- [ ] Runbook整備（標準フロー: 検索API/CLI、フォールバック: ブラウザ手動）とデータ品質チェック（フェーズ9タスク6）
  - 今回やらない理由: 実測・クエリ改善に集中するため
  - 次回の着手条件: 1区以上の処理を継続運用できる状態になったタイミングで実施

***

## 付録（任意）

- メモ: フェーズ計画の正本は `docs/05-00-development-phases.md`（索引）と、`docs/05-09-instagram-account-url-coverage.md`（詳細計画）です。
