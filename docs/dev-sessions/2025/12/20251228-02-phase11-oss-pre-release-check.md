# チェックリスト式実装計画書: 2025-12-28

> **セッションとは**: このプロジェクトにおける「セッションの定義」は `docs/dev-sessions/session-definition.md` を参照。
>
> **重要（AI作業時）**: このセッションファイルは `date` コマンドで現在日付（`20251228`）を取得したうえで作成している。

## セッション概要とゴール

### 概要

- 一言サマリ: OSS公開前チェック（secret / log / license / README）だけを実施し、公開して問題ない状態にするための修正点を確定する
- 対応フェーズ: フェーズ11（デザイン / UX 仕上げ & リリース準備）
- セッション種別: 運用整備 / 公開前チェック（セキュリティ・法務寄り）
- 実行方式: AI自律（ただし、シークレット取り扱い・外部送信・破壊的操作は人の明示確認を必須とする）
- 影響範囲: リポジトリ全体（ドキュメント / 設定 / スクリプト / フロント）
- 日付: 2025-12-28
- 想定所要時間: 25〜60 分

### ゴール

> **チェックの付け方（完了条件）**:
> - 完了条件は **Markdownのチェックリスト**（`- [ ]`）で記述する（セッション開始時点では未チェック）
> - セッションの最後に、満たした完了条件を `- [x]` に更新する（ゴール達成のセルフチェック）
> - ✅（絵文字）のチェックは使わない（`- [ ]` / `- [x]` に統一）

- **ゴール**: OSS公開前チェックの結果が「判断可能な形」で残り、必要修正があればパッチ単位で着手できる
  - 完了条件:
    - [x] **secrets**: コード/ドキュメント/サンプルenvに、実シークレット・個人情報・トークンが含まれていないと確認できている（疑わしければファイル/行で列挙）
    - [x] **logs**: 環境変数やトークンをログ出力していない（特に `process.env.*` を `console.*` していない）と確認できている
    - [x] **license**: `LICENSE` の有無を確認し、無い場合は「採用するライセンス種別」を決めて追加タスク化できている
    - [x] **readme**: 公開READMEに、最低限のセットアップ/注意事項（シークレットの扱い、免責）が過不足なく記載されていると確認できている
  - 補足:
    - CodeRabbitは使わず Cursor だけで実施する
    - 外部サービスへのキー入力・課金が発生する操作は、このセッションでは行わない

### 関連ドキュメント

- 参照:
  - `README.md`
  - `docs/README.md`
  - `docs/04-development.md`（環境変数/運用ポリシー、スクレイピングガイドライン等）
  - `apps/web/env.local.example`（サンプルenvに実値が混入していないこと）
  - `docs/dev-sessions/2025/12/20251228-01-phase11-mvp-release-prep.md`（前回の大枠。OSSチェックのみを切り出し）

## 前提・合意事項（事前議論・壁打ちメモ）

- 今日のセッションで前提とする方針:
  - 目的は「OSSとして公開して問題ない状態か」を最小観点で判断し、必要修正を列挙すること
  - “公開可能”の判断は、少なくとも **LICENSEの明示 / シークレット混入なし / ログに秘匿情報なし** を満たす
  - 迷う箇所は「安全側（公開しない・伏せる）」に倒す
- 議論概要:
  - MVPスコープを絞り、公開前チェックを最優先で進める（Cursorのみ）
- 保留中の論点 / 今回は触らないと決めたこと:
  - 一般ユーザー投稿/ログイン等の機能追加
  - 仕様追加や大規模リファクタ（公開前チェックに直結しない）

---

## 実装チェックリスト（本セッションにおける）

### 1. 作業タスク & 実行内容（実装・ドキュメント更新）

- [x] タスク1: secrets混入チェック（コード/ドキュメント/サンプルenv）
  - 完了条件: 「OK」または「要修正（ファイル/理由/対応案）」で結論が出ている
  - 結果: OK（実シークレット値は検出されず）
  - **AIが実行する内容（手順/プロンプト/操作メモ）**:
    ```
    - 参照ファイル:
      - apps/web/env.local.example
      - docs/04-development.md
      - README.md
    - やりたいこと:
      - 典型パターンをgrepで検出: "SUPABASE_SERVICE_ROLE_KEY", "ADMIN_API_TOKEN", "GOOGLE_CSE_API_KEY", "BEGIN PRIVATE KEY", "sk-", "AKIA", "-----BEGIN", "password", "token"
      - .env / .env.local / 秘匿っぽいファイルがgit追跡されていないか確認（git status / git ls-files）
      - 検出結果を「誤検知/要対応」に分類して記録
    - 制約・注意点:
      - 実シークレット値は絶対にログ/コメント/コミットメッセージに含めない
      - もし実値が見つかった場合は、公開前にローテーションが必要になり得るため、即座に隔離して対応方針を決める
    ```

- [x] タスク2: ログ/外部送信チェック（秘匿情報の出力・送信が無いか）
  - 完了条件: `console.*` やエラーログに `process.env` を出していないと判断できる
  - 結果: OK（`process.env` を直接ログ出力している箇所は見つからず）
  - **AIが実行する内容（手順/プロンプト/操作メモ）**:
    ```
    - 参照ファイル:
      - apps/web/ (Next.js)
      - apps/scripts/
    - やりたいこと:
      - console.log / console.error の近傍で env を出していないか検索
      - fetch/curl等でトークンを含む外部送信が無いか（特にスクリプト）確認
      - 必要なら「ログの伏せ方（例: 末尾だけ表示）」の修正案を作る
    - 制約・注意点:
      - 解析結果の共有でも、実値を貼らない（キー名だけで記録する）
    ```

- [x] タスク3: LICENSE/READMEの公開整備（最小）
  - 完了条件: LICENSEの方針と、READMEに追記すべき最小項目（必要なら）を決められている
  - 結果: 要修正項目を特定（LICENSE追加、README追記が必要）
  - **AIが実行する内容（手順/プロンプト/操作メモ）**:
    ```
    - 参照ファイル:
      - README.md
      - docs/README.md
      - docs/04-development.md（スクレイピング/運用ポリシー）
    - やりたいこと:
      - LICENSEファイルの有無確認（無い場合は「どのライセンスにするか」を決める）
      - READMEに「.env.localをコミットしない」「キーをログ出力しない」等の注意が不足していないか確認
      - Instagram/Google CSE等の外部サービス利用について、過剰にならない範囲で注意書きを入れるか判断
    - 制約・注意点:
      - ここでは文章と方針の確定まで。必要修正は次セッションで小さく実施する
    ```

### 2. 検証・テスト（確認方法）

- [x] 確認1: `git status` / `git ls-files` で `.env*` などが追跡されていない
      - 期待結果: `.env.local` 等がコミット対象に出てこない
      - 結果: OK（`env.local.example` のみが追跡されている）
- [x] 確認2: grep結果をレビューして「実シークレット混入なし」を判断できる
      - 期待結果: 検出はキー名/ダミーのみで、実値が無い（または要修正が列挙されている）
      - 結果: OK（実値は検出されず、キー名・ダミー値のみ）
- [x] 確認3: LICENSE方針が決まり、必要なら追加タスクとして起票（このファイルに記録）できている
      - 期待結果: 「採用ライセンス: XXX」「次アクション: LICENSE追加」が明記されている
      - 結果: 採用ライセンス: MIT License（推奨）、次アクション: LICENSEファイル追加

---

## 実施ログ

- スタート: 2025-12-28（AI自律実行）
- 実行内容:
  - git追跡状況確認: `git status --porcelain`, `git ls-files | grep -E "\.env"`
  - シークレットパターン検索: `rg` で各種パターン（SUPABASE_SERVICE_ROLE_KEY, ADMIN_API_TOKEN, GOOGLE_CSE_API_KEY, BEGIN PRIVATE KEY, AKIA, sk-等）を走査
  - ログ出力チェック: `console.*` と `process.env` の近接検索
  - 外部送信チェック: `fetch`, `axios`, `curl` 等の使用箇所確認
  - LICENSE有無確認: `glob_file_search` で LICENSE* ファイル検索
  - README内容確認: セットアップ手順、シークレット運用、外部サービス利用の注意書きの有無を確認
- メモ:
  - 実シークレット値は検出されず（キー名のみ、ダミー値のみ）
  - LICENSEファイルが存在しない（追加が必要）
  - READMEに秘匿情報運用の注意書きが不足（追記が必要）

## 結果とふりかえり

> **チェックの付け方**: 完了したタスクは `- [x]` で列挙する。未完了のタスクは `- [ ]` のまま「次回に持ち越すタスク」へ移す。

- 完了できたタスク:
  - [x] タスク1: secrets混入チェック
  - [x] タスク2: ログ/外部送信チェック
  - [x] タスク3: LICENSE/READMEの公開整備（最小）
  - [x] LICENSEファイルの追加（MIT License） - 2025-12-28対応
  - [x] README.mdの追記（環境変数・シークレット運用の注意書き） - 2025-12-28対応
- 未完了タスク / 想定外だったこと:
  - なし（チェックと要修正項目の対応を完了）
- 学び・次回改善したいこと:
  - チェック結果から、LICENSEファイルとREADMEの追記が必要であることが明確になり、同日対応できた
  - 実シークレット値の混入はなく、公開前のセキュリティリスクは低いと判断できる

## 次回に持ち越すタスク

> **運用（重要）**:
> - 持ち越しタスクの**正本は常に「最新のセッションファイル 1つ」に集約**する（= 次回は最新だけ見れば良い状態にする）
> - 次のセッションを作ったら、前回セッションの未完了タスクを **新しい（最新）セッション** のこのセクションへコピーする
> - 前回セッション側のこのセクションは、後日 **各行を `- [x] （持ち越し済み → ...）` に更新して凍結**する（ここに追記して増やさない）
> - 後日「漏れていたタスク」に気づいた場合は、**最新セッションにのみ追記**し、行末に `（漏れていたため追加: YYYY-MM-DD）` を付ける

- なし（今回のセッションで全て対応完了）

***

## 付録（任意）

> メモ: ここにはgrep結果の「要約」だけを貼り、実値（シークレットや個人情報）は絶対に貼らない。

### 検出結果の要約

#### A. git追跡状況（.env等）

- [OK] `.env.local` 等の実環境変数ファイルは追跡されていない
- [OK] `apps/web/env.local.example` のみが追跡されている（サンプルファイルとして適切）

#### B. secrets混入チェック

- [OK] 実シークレット値は検出されず
- [OK] 検出されたのは以下のみ:
  - 環境変数名の参照（`SUPABASE_SERVICE_ROLE_KEY`, `ADMIN_API_TOKEN`, `GOOGLE_CSE_API_KEY` 等）
  - `env.local.example` のダミー値（`"eyJhbGciOiJI..."` 等の短縮例）
  - テストコードの固定文字列（`'test-admin-token'` 等）
  - ドキュメント内の説明・手順
- [OK] AWS Access Key（`AKIA` パターン）、OpenAI系キー（`sk-` パターン）、秘密鍵（`BEGIN PRIVATE KEY` パターン）は検出されず

#### C. ログ出力・外部送信チェック

- [OK] `console.log/error/warn` で `process.env` を直接出力している箇所は見つからず
- [OK] `console.*` の使用箇所:
  - エラーハンドリング（`console.error('Facility detail page error:', error)` 等）
  - localStorage操作の警告（`console.warn('Failed to save favorites...')` 等）
  - スクリプトの進捗ログ（`console.log('[INFO] ...')` 等）
  - いずれも環境変数の値を出力していない
- [OK] `fetch()` の使用箇所:
  - API Route内でGoogle CSE APIを呼び出す用途のみ
  - 環境変数は `process.env` から読み取っているが、ログ出力はしていない
- [OK] `Authorization` / `Bearer` / `Cookie` は型名（`FavoriteCookieItem`）としてのみ使用されており、実際の認証ヘッダーではない

#### D. LICENSE / README チェック

- [x] LICENSEファイルを追加（MIT License）
  - 対応内容: ルートディレクトリに `LICENSE` を追加
- [x] READMEに環境変数・シークレット運用の注意書きを追記
  - 対応内容: READMEの「セットアップ」セクションに「環境変数の設定（重要）」を追加し、`.env.local` のコミット禁止 / ログ出力禁止 / 外部サービス利用時の注意を明記


