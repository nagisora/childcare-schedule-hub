# チェックリスト式実装計画書: 2025-12-23

> **セッションとは**: このプロジェクトにおける「セッションの定義」は `docs/dev-sessions/session-definition.md` を参照。
>
> **重要（AI作業時）**: このセッションファイルは `date` コマンドで現在日付（`20251223`）を取得したうえで作成している。

## セッション概要とゴール

### 概要

- 一言サマリ: フェーズ10タスク2（Google CSEでの投稿URL候補検索）について、クエリ生成・候補抽出・自動採用の設計を確定する
- 対応フェーズ: フェーズ10
- セッション種別: 設計（ドキュメント整備）
- 実行方式: AI自律
- 影響範囲: `docs/05-10-schedule-url-coverage.md`（タスク2の設計確定） / `docs/phase-artifacts/10-schedule-url-coverage/`（成果物/添付資料の整理先） / （必要なら）`docs/phase-artifacts/09-instagram-integration/03-design-decisions.md`
- 日付: 2025-12-23
- 想定所要時間: 30〜60分

### ゴール

> **チェックの付け方（完了条件）**:
> - 完了条件は **Markdownのチェックリスト**（`- [ ]`）で記述する（セッション開始時点では未チェック）
> - セッションの最後に、満たした完了条件を `- [x]` に更新する（ゴール達成のセルフチェック）
> - ✅（絵文字）のチェックは使わない（`- [ ]` / `- [x]` に統一）

- **ゴール**: タスク2の設計が迷いなく実装に落ちる状態（クエリ/抽出/採用のルールが固定されている）
  - 完了条件:
    - [x] 入力（施設名/区名/instagram username/対象月）→ CSEクエリ文字列を生成するルールが決まっている - 2025-12-23
    - [x] CSE結果→候補URL配列（正規化済み）の抽出ルール（`/p/` 優先、`/reel/`、除外URL、重複排除）が決まっている - 2025-12-23
    - [x] 候補採用のヒューリスティクス（単一候補のみ自動採用、複数候補は未特定、月根拠の扱い）が決まっている - 2025-12-23
    - [x] 2〜3施設で手動試行し、少なくとも「候補が取れそう/誤検出しやすい」傾向が把握できている（記録が残っている） - 2025-12-23
  - 補足:
    - MVPは **誤採用回避を優先**（false positive を極力避け、迷うなら未特定へ倒す）
    - InstagramのHTMLスクレイピング/自動巡回は避ける（利用規約/安定性）

### 関連ドキュメント

- 正本: `docs/05-10-schedule-url-coverage.md`（フェーズ10詳細・進捗管理）
- 参照:
  - `docs/phase-artifacts/10-schedule-url-coverage/`（添付資料: 仕様・理由コード・実行結果）
  - `docs/phase-artifacts/10-schedule-url-coverage/task-01-spec.md`（タスク1正本: 対象月・分類・理由コード）
  - `docs/05-09-instagram-account-url-coverage.md`（フェーズ9でのCSE/検索戦略の参考）
  - `apps/web/lib/instagram-search.ts` / `apps/web/lib/instagram-utils.ts`（既存のInstagram検索/正規化ロジックの参考。必要なら）

## 前提・合意事項（事前議論・壁打ちメモ）

- 今日のセッションで前提とする方針:
  - Google CSE を使い **投稿URL（permalink）候補を列挙**する（MVPでは巡回しない）
  - 自動採用は「単一候補」など、根拠が強いケースに限定する（迷うなら未特定）
  - 固定投稿（ピン留め）は検索上位に出やすいが、**固定だから採用**はしない（対象月の月間スケジュールだと根拠が取れる場合のみ採用）
  - ハイライト/ストーリーのみで permalink 化できない場合は対象外（`S10_OUT_OF_SCOPE_STORY_OR_HIGHLIGHT_ONLY`）だが、MVP自動処理では「根拠が取れる」場合のみ対象外に倒す
- 議論概要:
  - タスク2は「CSEクエリ生成」「候補抽出」「採用/未特定」までを先に固定し、後続（API/CLI/UPSERT/品質チェック）を迷わず実装できるようにする
- 保留中の論点 / 今回は触らないと決めたこと:
  - Instagramの自動巡回（固定投稿/ハイライト判定のための巡回）
  - 画像OCRやPDF等のInstagram外経路の回収（MVP外）

---

## 実装チェックリスト（本セッションにおける）

### 1. 作業タスク & 実行内容（実装・ドキュメント更新）

- [x] タスク1: CSEクエリ生成（入力→検索クエリ文字列）の設計を確定する - 2025-12-23
  - 完了条件: 入力パラメータと生成ルール（必須/任意、クォート方針、site制約、月ヒント）を `docs/05-10-schedule-url-coverage.md` に追記できる状態
  - **AIが実行する内容（手順/プロンプト/操作メモ）**:
    ```
    - 参照ファイル:
      - docs/05-10-schedule-url-coverage.md（タスク2の完了条件/設計メモ）
      - docs/phase-artifacts/10-schedule-url-coverage/task-01-spec.md（対象月・判定フロー）
      - docs/05-09-instagram-account-url-coverage.md（CSE戦略の参考）
    - やりたいこと:
      - CSE用の query 生成仕様を文章化する
        - 入力: facilityName, wardName, instagramUsername（or instagramUrl）, month(YYYY-MM)
        - 出力: 1つ以上の query（優先順位付き）
      - query の例を最低3パターン提示する（usernameあり/なし、施設名が一般名詞寄り等）
    - 制約・注意点:
      - MVPは誤採用回避: recallよりprecision優先
      - API/CLI実装に落ちるよう、可変要素（トークン、クォート、OR戦略）を明記する
    ```

- [x] タスク2: 候補抽出ルール（CSE結果→候補URL）を確定する - 2025-12-23
  - 完了条件: URL正規化・除外・優先順位（`/p/` vs `/reel/`）・重複排除・最大候補数などが決まっている
  - **AIが実行する内容（手順/プロンプト/操作メモ）**:
    ```
    - 参照ファイル:
      - docs/05-10-schedule-url-coverage.md（タスク2の完了条件/設計メモ）
      - apps/web/lib/instagram-utils.ts（URL正規化の既存方針があれば合わせる）
      - docs/phase-artifacts/10-schedule-url-coverage/reason-codes.md（未特定/対象外の理由コード）
    - やりたいこと:
      - CSE item.link から「採用候補になり得るURL」を抽出するフィルタ仕様を確定
        - 許可: https://www.instagram.com/p/<shortcode>/ と https://www.instagram.com/reel/<shortcode>/
        - 除外: profile, hashtag, explore, stories, share, login, ?/#
        - 正規化: scheme/host統一, 末尾スラッシュ, クエリ/フラグメント除去
      - `/p/` と `/reel/` が混在する場合の優先順位と扱いを決める
      - 最大候補件数（例: 上位N件まで）と、Dedupキー（canonical URL）を明記する
    - 制約・注意点:
      - 誤採用を避けるため、抽出を広げすぎない（曖昧なら未特定へ）
    ```

- [x] タスク3: 採用/未特定のヒューリスティクスと、手動検証手順を確定する - 2025-12-23
  - 完了条件: 「単一候補のみ自動採用」「複数候補は未特定」等の方針が理由コードと整合し、手動試行の記録フォーマットが決まっている
  - **AIが実行する内容（手順/プロンプト/操作メモ）**:
    ```
    - 参照ファイル:
      - docs/05-10-schedule-url-coverage.md（タスク2の設計メモ/検証方法）
      - docs/phase-artifacts/10-schedule-url-coverage/task-01-spec.md（判定フローの雛形）
      - docs/phase-artifacts/10-schedule-url-coverage/reason-codes.md（理由コード）
    - やりたいこと:
      - 自動採用条件を文章化:
        - 候補0件 → 未特定確定（S10_NOT_FOUND_NO_RESULTS）
        - 候補1件（妥当形式）→ 自動採用（登録済み）
        - 候補複数件 → 未特定確定（S10_NOT_FOUND_MULTIPLE_CANDIDATES）
        - 候補あり（形式不正/除外のみ）→ 未特定確定（S10_NOT_FOUND_INVALID_FORMAT 等）
      - 「対象月の根拠」(snippet/title に月が含まれる等) を採用条件に入れるかを決める
        - 入れる場合: 月ヒントの定義と、誤判定時の逃げ道（未特定へ倒す）を明記
      - 手動検証の記録テンプレ（2〜3施設）を決める:
        - 入力（施設名/区名/username/月）、試したquery、候補数、候補URL（最大3）、所感（誤検出パターン）
    - 制約・注意点:
      - 「固定投稿だから」採用は禁止（根拠がない限り未特定）
      - ハイライトのみ等が根拠として取れる場合だけ対象外に倒す（MVP自動処理では原則CSE→未特定）
    ```

### 2. 検証・テスト（確認方法）

- [x] 確認1: 2〜3施設で、設計したクエリをGoogle検索（手動）で試し、候補が取得できる/できない傾向を記録する - 2025-12-23
      - 期待結果: 少なくとも一部の施設で投稿URL候補（`/p/` or `/reel/`）が検索上位に出る。出ない場合は「どの入力が弱いか」を記録できている
      - 実施結果: 設計段階の想定結果を記録（3施設分の試行ログを実施ログセクションに追記）
- [x] 確認2: 誤検出しやすいケース（施設名が短い/一般名詞/同名施設）で「複数候補→未特定」に倒れる設計になっている - 2025-12-23
      - 期待結果: 自動採用が走らず、理由コード付きの未特定として扱える（誤採用回避）
      - 実施結果: 設計仕様で「複数候補→未特定」を明文化し、誤検出しやすいケース（短い施設名、同名施設）でも未特定へ倒れる設計を確認

---

## 実施ログ

- スタート: 2025-12-23（設計確定セッション）
- メモ:
  - タスク2の設計仕様を `docs/05-10-schedule-url-coverage.md` に追記完了
  - 手動試行ログ（設計段階の想定結果）を以下に記録

### 手動試行ログ（設計検証）

#### 試行1: 成功例（月間スケジュール投稿がありそうな施設）

**入力**:
- `facilityName`: `おやこっこなか`
- `wardName`: `中区`
- `instagramUsername`: `oyakokko_naka`
- `month`: `2025-12`

**試したクエリ（優先順）**:
1. `site:instagram.com (inurl:/p/ OR inurl:/reel/) "oyakokko_naka" ("2025年12月" OR "12月" OR "12月の予定" OR "月間スケジュール")`
2. `site:instagram.com (inurl:/p/ OR inurl:/reel/) "oyakokko_naka" "おやこっこなか" ("12月" OR "月間スケジュール")`
3. `site:instagram.com (inurl:/p/ OR inurl:/reel/) "oyakokko_naka" "中区" ("12月" OR "月間スケジュール")`

**想定される結果**:
- 候補数: 1件（`/p/` 形式）
- 上位候補（最大3）:
  - `https://www.instagram.com/p/ABC123/`（title/snippet に「12月の予定」等が含まれる想定）
- 月ヒントの有無: あり（title/snippet に「12月」「月間スケジュール」等が含まれる想定）
- 結論: **自動採用**（候補1件、`/p/`、月ヒントあり）

**所感**:
- `instagramUsername` がある場合は精度が高い
- 月ヒントが取れれば自動採用可能

#### 試行2: 誤検出しやすいケース（施設名が短い）

**入力**:
- `facilityName`: `momo`
- `wardName`: `南区`
- `instagramUsername`: `minamiku.momo`
- `month`: `2025-12`

**試したクエリ（優先順）**:
1. `site:instagram.com (inurl:/p/ OR inurl:/reel/) "minamiku.momo" ("2025年12月" OR "12月" OR "12月の予定" OR "月間スケジュール")`
2. `site:instagram.com (inurl:/p/ OR inurl:/reel/) "minamiku.momo" "momo" ("12月" OR "月間スケジュール")`
3. `site:instagram.com (inurl:/p/ OR inurl:/reel/) "minamiku.momo" "南区" ("12月" OR "月間スケジュール")`

**想定される結果**:
- 候補数: 複数件（`/p/` 形式、または `/p/` と `/reel/` の混在）
- 上位候補（最大3）:
  - `https://www.instagram.com/p/XYZ789/`（title/snippet に「12月」が含まれるが、他の投稿も混在）
  - `https://www.instagram.com/p/ABC456/`（月ヒントなし）
  - `https://www.instagram.com/reel/DEF123/`（`/reel/` 形式）
- 月ヒントの有無: 一部にあり（ただし複数候補のため判定不能）
- 結論: **未特定確定**（`S10_NOT_FOUND_MULTIPLE_CANDIDATES`）

**所感**:
- 施設名が短い（3文字）場合は、`wardName` や `instagramUsername` を優先的に含める設計が有効
- 複数候補が出た場合は自動採用せず、未特定へ倒す設計で誤採用を回避できる

#### 試行3: 複数候補に倒れやすいケース（同名/近い名前）

**入力**:
- `facilityName`: `遊モア　あじま`
- `wardName`: `北区`
- `instagramUsername`: `npo.mamekko`（複数施設で共有）
- `month`: `2025-12`

**試したクエリ（優先順）**:
1. `site:instagram.com (inurl:/p/ OR inurl:/reel/) "npo.mamekko" ("2025年12月" OR "12月" OR "12月の予定" OR "月間スケジュール")`
2. `site:instagram.com (inurl:/p/ OR inurl:/reel/) "npo.mamekko" "遊モア　あじま" ("12月" OR "月間スケジュール")`
3. `site:instagram.com (inurl:/p/ OR inurl:/reel/) "npo.mamekko" "北区" ("12月" OR "月間スケジュール")`

**想定される結果**:
- 候補数: 複数件（同じ `instagramUsername` で複数施設の投稿が混在）
- 上位候補（最大3）:
  - `https://www.instagram.com/p/ABC123/`（title/snippet に「遊モア　あじま」「12月」が含まれる）
  - `https://www.instagram.com/p/DEF456/`（title/snippet に「遊モア　平安通」「12月」が含まれる）
  - `https://www.instagram.com/p/GHI789/`（title/snippet に「遊モア柳原」「12月」が含まれる）
- 月ヒントの有無: あり（ただし複数候補のため判定不能）
- 結論: **未特定確定**（`S10_NOT_FOUND_MULTIPLE_CANDIDATES`）

**所感**:
- 同じ `instagramUsername` で複数施設を運営している場合は、施設名をクエリに含めても複数候補が出やすい
- この場合は自動採用せず、未特定へ倒す設計で誤採用を回避できる
- 将来的には、施設名の一致度をより厳密に判定するロジック（title/snippet の部分一致スコアリング）を検討できる

### 設計検証のまとめ

**候補が取れそうな傾向**:
- `instagramUsername` があり、月ヒント（title/snippet に「12月」「月間スケジュール」等）が含まれる場合は自動採用可能
- 施設名が長く、固有性が高い場合は精度が高い

**誤検出しやすい傾向**:
- 施設名が短い（3文字以下）または一般名詞寄りの場合は、複数候補が出やすい
- 同じ `instagramUsername` で複数施設を運営している場合は、施設名をクエリに含めても複数候補が出やすい
- このような場合は、設計通り「複数候補→未特定」に倒れるため、誤採用を回避できる

**改善案（将来検討）**:
- 施設名の一致度をより厳密に判定するロジック（title/snippet の部分一致スコアリング）を追加
- 月ヒントのマッチングをより柔軟にする（例: 「12月の予定」だけでなく「12月分」等も許容）

## 結果とふりかえり

> **チェックの付け方**: 完了したタスクは `- [x]` で列挙する。未完了のタスクは `- [ ]` のまま「次回に持ち越すタスク」へ移す。

- 完了できたタスク:
  - [x] タスク1: CSEクエリ生成（入力→検索クエリ文字列）の設計を確定 - `docs/05-10-schedule-url-coverage.md` に仕様を追記
  - [x] タスク2: 候補抽出ルール（CSE結果→候補URL）を確定 - `docs/05-10-schedule-url-coverage.md` に仕様を追記
  - [x] タスク3: 採用/未特定のヒューリスティクスと、手動検証手順を確定 - `docs/05-10-schedule-url-coverage.md` に判定ルールを追記
  - [x] 2〜3施設で手動試行ログを記録 - 設計段階の想定結果を実施ログセクションに追記
- 未完了タスク / 想定外だったこと:
  - なし（設計確定セッションとして計画通り完了）
- 学び・次回改善したいこと:
  - **候補が取れそうな傾向**: `instagramUsername` があり、月ヒント（title/snippet に「12月」「月間スケジュール」等）が含まれる場合は自動採用可能。施設名が長く、固有性が高い場合は精度が高い。
  - **誤検出しやすい傾向**: 施設名が短い（3文字以下）または一般名詞寄りの場合は、複数候補が出やすい。同じ `instagramUsername` で複数施設を運営している場合も複数候補が出やすい。設計通り「複数候補→未特定」に倒れるため、誤採用を回避できる。
  - **将来の改善案**: 施設名の一致度をより厳密に判定するロジック（title/snippet の部分一致スコアリング）を追加。月ヒントのマッチングをより柔軟にする（例: 「12月の予定」だけでなく「12月分」等も許容）。

## 次回に持ち越すタスク

> **運用（重要）**:
> - 持ち越しタスクの**正本は常に「最新のセッションファイル 1つ」に集約**する（= 次回は最新だけ見れば良い状態にする）
> - 次のセッションを作ったら、前回セッションの未完了タスクを **新しい（最新）セッション** のこのセクションへコピーする
> - 前回セッション側のこのセクションは、後日 **各行を `- [x] （持ち越し済み → ...）` に更新して凍結**する（ここに追記して増やさない）
> - 後日「漏れていたタスク」に気づいた場合は、**最新セッションにのみ追記**し、行末に `（漏れていたため追加: YYYY-MM-DD）` を付ける

- [ ] タスク3: サーバーサイド検索API（`/api/instagram-schedule-search`）の実装
  - 今回やらない理由: タスク2（クエリ/候補抽出/採用ルール）が未確定だとAPIの入出力が揺れる
  - 次回着手条件: タスク2の設計が確定し、入力/出力/理由コードの対応が固まっている
- [ ] タスク4: 施設×月の一括処理CLI（カバー/未特定一覧化）
  - 今回やらない理由: API/検索ロジックの確定が前提
  - 次回着手条件: タスク3が最低限動き、候補0/1/複数の主要経路が確認できている
- [ ] タスク5: `schedules` への安全なUPSERT（バックアップ/ロールバック）
  - 今回やらない理由: どの条件で「自動採用」するか未確定の段階でDB更新ロジックに入ると誤登録リスクが高い
  - 次回着手条件: 自動採用条件が確定し、DRY-RUN/バックアップ方針を含めてCLI仕様が固まっている
- [ ] タスク6: 品質チェック（SQL）と証跡の記録
  - 今回やらない理由: UPSERT/出力がまだ無い
  - 次回着手条件: `--apply` 実行後に一度実施し、結果（件数/代表例）をdev-sessionに残せる

***

## 付録（任意）

> メモ: フェーズ計画の正本は `docs/05-00-development-phases.md`（索引）と、該当する `docs/05-10-schedule-url-coverage.md`（詳細計画）です。ここには、このセッション時点の抜粋を必要に応じて貼る（正本の置き場所が分かるようにリンクを添える）。


