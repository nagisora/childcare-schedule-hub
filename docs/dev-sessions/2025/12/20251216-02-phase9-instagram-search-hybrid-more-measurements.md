# チェックリスト式実装計画書: 2025-12-16

> **重要（AI作業時）**: このファイルは `date +%Y%m%d` の結果（`20251216`）に基づいて作成している。  
> ルール: `docs/dev-sessions/README.md` / `docs/05-00-development-phases.md#dev-sessions-date`

## セッション概要とゴール

### 概要

- 一言サマリ: hybrid戦略の追加実測（複数区で合計15〜20件）を行い、rank vs hybrid の差分（0/1/複数・複数候補での上位入れ替わり）を表にまとめ、`scoreCandidate` 改善の着手点を確定する
- 対応フェーズ: フェーズ9
- セッション種別: 実測 + 分析 + ドキュメント整備（コード変更は原則しない）
- 影響範囲: `apps/scripts/instagram-semi-auto-registration.ts`（実行） / `apps/scripts/logs/`（生成物） / `docs/dev-sessions/`
- 日付: 2025-12-16
- 想定所要時間: 60〜120 分（実測＋表作成。途中で分割してOK）

### ゴール

> **チェックの付け方（完了条件）**:
> - 完了条件は **Markdownのチェックリスト**（`- [ ]`）で記述する（開始時点では未チェック）
> - セッションの最後に、満たした完了条件を `- [x]` に更新する（ゴール達成のセルフチェック）

- **ゴール**: 東区以外で追加実測を積み、rank主経路を維持したまま hybrid の評価材料（差分が出るケース）を増やす
  - 完了条件:
    - [ ] 東区以外で合計15〜20件のDRY-RUNを実施し、rank/hybrid比較ログ（`instagram-registration-*.json`）を保存している
    - [ ] 施設ごとの比較表（候補数 0/1/複数、複数候補時の「hybridで上位が入れ替わったか」）を作成している
    - [ ] 次回の `scoreCandidate` 改善の仮説（上位3つ）と、追加実測が必要な条件を言語化している
  - 補足:
    - シークレット（APIキー/トークン）は絶対に表示・ログ出力しない
    - 実測は **DRY-RUN**（DB更新は別セッション）
    - 可能なら「複数候補が出る施設」を増やす（hybrid差分が見えやすい）
    - **AIが自律的に実行**: このセッションのタスク（CLI実行・比較表作成・仮説確定）は、AIがユーザーの追加指示なしで完了まで進める

### 関連ドキュメント

- 参照: `docs/05-09-instagram-account-url-coverage.md`（フェーズ9正本）
- 参照: `docs/dev-sessions/2025/12/20251216-01-phase9-instagram-search-hybrid-strategy.md`（前回: hybrid導入＋緑区8件の実測）
- 参照: `apps/scripts/instagram-semi-auto-registration.ts`（CLI実測・ログ出力）

## 前提・合意事項（事前議論・壁打ちメモ）

- 今日のセッションで前提とする方針:
  - **rankを主経路**（運用上の安全装置と相性が良い）
  - hybridは「rankで拾った候補をscoreで再評価して並べ替え」する評価用の第3戦略
  - まずは **実測データを増やし、改善の根拠を集める**（このセッションでは原則コード変更しない）
  - **AIが自律的に実行**: このセッションのタスク（CLI実行・比較表作成・仮説確定）は、AIが自律的に実行する（ユーザーの追加指示なしで完了まで進める）
- 議論概要:
  - 前回の緑区8件では、複数候補が1件のみで hybrid の差分が見えづらかった
- 保留中の論点 / 今回は触らないと決めたこと:
  - DB更新（`--apply --yes`）
  - `scoreCandidate` の重み調整の実装（根拠が揃ってから次回）

---

## 実装チェックリスト（本セッションにおける）

### 1. 作業タスク & プロンプト設計（実測・分析・ドキュメント更新）

- [ ] タスク1: 追加実測（複数区で合計15〜20件）をDRY-RUNで実行し、rank/hybrid比較ログを収集する（AIが自律的に実行）
  - 完了条件:
    - [ ] 対象区を決め、各区で `--compare-strategies` を実行して `apps/scripts/logs/instagram-registration-*.json` が生成されている
    - [ ] 0件（no_candidates）と複数候補（2件以上）の件数を、各区ごとに把握できる
  - **AIが実行する内容**:
    - 東区以外で合計15〜20件になるように区を選ぶ（例: 港区(6) + 守山区(5) + 名東区(4) = 15件。不足なら天白区などを追加）
    - 各区ごとに `pnpm tsx instagram-semi-auto-registration.ts --ward=<区名> --compare-strategies` を実行（`apps/scripts` ディレクトリから）
    - 実行結果を確認し、`apps/scripts/logs/instagram-registration-*.json` が生成されていることを確認
    - 各ログファイルから、0件（no_candidates）と複数候補（2件以上）の件数を集計
  - **制約・注意点**:
    - DB更新はしない（`--apply` を付けない）
    - シークレット（APIキー/トークン）はログに出さない
    - 無料枠/クエリ数を意識し、20件を上限にする

- [ ] タスク2: 施設ごとの比較表を作成し、差分ケース（複数候補・上位入れ替わり）を抽出する（AIが自律的に実行）
  - 完了条件:
    - [ ] 施設ごとに「候補数（rank/hybrid）」と「複数候補時の上位入れ替わり有無」を表にまとめている
    - [ ] no_candidates（0件）と複数候補（2件以上）の一覧が作れている
  - **AIが実行する内容**:
    - `apps/scripts/logs/instagram-registration-*.json` を読み込み、各施設の結果を抽出
    - 施設名/区、rank候補数、hybrid候補数、複数候補のとき「hybridで上位が入れ替わったか」を表にする
      - 複数候補のとき: rank と hybrid の上位候補の順序を比較し、入れ替わり有無を判定
    - no_candidates の施設は `triedQueries` も併記して、次回の改善材料にする
    - このdev-sessionの「結果とふりかえり」セクションに表をMarkdown形式で追加
  - **注意**:
    - 「正候補が含まれるか」は人間判断が必要なため、このセッションでは「候補数」と「差分の有無」に集中してOK

- [ ] タスク3: 次回の `scoreCandidate` 改善に向けた仮説を確定する（AIが自律的に実行、実装は次回）
  - 完了条件:
    - [ ] no_candidates の共通パターン仮説（クエリ側の問題か、施設名の揺れか等）を1〜2行で書ける
    - [ ] 複数候補で「入れ替わりが起きた」「上位が怪しい」ケースを最大3件ピックし、改善仮説を箇条書きで残す
  - **AIが実行する内容**:
    - 収集した実測データ（比較表とログファイル）を分析
    - no_candidates の共通パターンを抽出:
      - `triedQueries` を確認し、クエリ側の問題か施設名の揺れかを切り分け
      - 共通パターンを1〜2行で仮説として言語化
    - 複数候補で「入れ替わりが起きた」「上位が怪しい」ケースを最大3件ピック:
      - rank と hybrid で順序が異なるケースを特定
      - 各ケースについて「どのルール/重みで改善するか」の仮説を箇条書きで残す
    - このdev-sessionの「結果とふりかえり」セクションに改善仮説を記録
  - **注意**:
    - 実装は次回に回す（このセッションでは仮説の確定まで）

### 2. 検証・テスト（確認方法・AIが自律的に実行）

- [ ] 確認1: CLI DRY-RUN の実行結果（AIが確認）
  - 期待結果: 各区で `=== Summary ===` が出て、`Mode: DRY-RUN (no updates)` になっている
  - **AIが実行**: 各CLI実行の出力を確認し、DRY-RUNモードで実行されていることを検証
- [ ] 確認2: ログ生成（AIが確認）
  - 期待結果: `apps/scripts/logs/instagram-registration-*.json` が対象区ぶん作成されている
  - **AIが実行**: ログディレクトリを確認し、対象区ぶんのJSONファイルが生成されていることを検証
- [ ] 確認3: まとめ表（AIが確認）
  - 期待結果: このdev-session内に比較表が残っている
  - **AIが実行**: このdev-sessionファイルに比較表が追加されていることを確認

---

## 実施ログ

- スタート: TODO: HH:MM
- 対象区（予定）: 港区 / 守山区 / 名東区（不足なら天白区）
- 実測ログ（TODO: 実行後にパスを貼る）:
  - TODO: apps/scripts/logs/instagram-registration-...

## 結果とふりかえり

- 完了できたタスク:
  - [ ] タスク1
  - [ ] タスク2
  - [ ] タスク3
- 未完了タスク / 想定外だったこと:
  - TODO:
- 学び・次回改善したいこと:
  - TODO:

## 次回に持ち越すタスク

> **このリストが持ち越しの正本（最新）**。前回までのセッションは「持ち越し済み」でクローズし、ここだけ見れば良い状態にする。

- [ ] scoreCandidate の改善（前回セッションのタスク3）
  - 今回やらない理由: まず実測データを増やして根拠を揃えるため
  - 次回の着手条件: 複数候補/誤上位/0件のパターンが十分に集まったら
- [ ] 再検索抑制キャッシュ（facilityId+query+results）の設計・実装
  - 今回やらない理由: 効率化/コスト削減が主目的で、精度改善を優先するため
  - 次回の着手条件: 同一施設・同一クエリの再実行が増えてきたら
- [ ] Runbook整備（標準フロー/フォールバック）とデータ品質チェック（フェーズ9タスク6）
  - 今回やらない理由: 実測・改善に集中するため
  - 次回の着手条件: 1区以上を継続運用できる状態になったら

***

## 付録（任意）

### AIからの提案（このセッションで扱う範囲について）

次のセッションは、「オプション1（追加実測）」に100%寄せて、コード変更は最小 or 0にするのが一番きれいだと思います。理由は、現状だと hybridの差が出る"複数候補ケース"が不足していて、`scoreCandidate` 改善を始める根拠が薄いからです。

#### 次セッションに含める範囲（おすすめ）

**1) 実測データ収集（メイン）**
- **目標件数**: 合計 **15〜20件**（上限20でOK）
- **対象区（おすすめ）**: 既に緑区8件を取れているので、次は **港区(6) + 守山区(5) + 名東区(4) + 天白区(4)** から、合計が **15〜20件**になるように選ぶ
  - 例: **港区6 + 守山区5 + 名東区4 = 15件**（ちょうど良い）
- **実行**: 区ごとに `--compare-strategies` を回して、生成された `instagram-registration-*.json` を"証跡"として残す

**2) 集計・比較表の作成（このセッション内で必ずやる）**
dev-sessionに、最低限この列の表を作る（コピペでOK）:
- 施設名 / 区
- rank: 候補数（0/1/複数）
- hybrid: 候補数（0/1/複数）
- **複数候補のとき**: 「hybridで上位が入れ替わったか」/ 「上位が妥当か（人間判断）」
  → ここで初めて「hybridが効いた/効いてない」が判断できる

**3) 改善案の"確定"まで（実装は次回でも可）**
- **no_candidates（0件）**が出たものは、クエリ（`triedQueries`）を見て「クエリ改善」か「スコア以前の問題」か切り分け
- **複数候補で誤上位が出たら**、`scoreCandidate` 改善の優先候補にする
- 最後に「次回はこれを直す」という**改善チケット（箇条書き）**をdev-sessionに残す

#### 次セッションに"入れない"方がいいもの（おすすめ）

- `scoreCandidate` の重み調整・ルール追加の実装（根拠不足で迷走しやすい）
- CLIの機能拡張（複数区まとめ実行など）（スコープが膨らみやすい）

#### 例外：もし"明確な失敗パターン"が出たら

同じセッション内で **1個だけ小さく直してOK**（ただし「テスト追加まで」セット）。  
それ以外は次回に回すのが安全です。
