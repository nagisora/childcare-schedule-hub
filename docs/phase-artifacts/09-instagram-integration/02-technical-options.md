# 02 技術選択肢の比較

## 概要

Instagram連携によるスケジュールURL取得のための技術選択肢を比較検討する。

## 選択肢一覧

### 1. Instagram公式API（oEmbed）

**概要**:
- Instagram公式のoEmbed APIを使用して投稿を埋め込み表示する
- 投稿URLが既知であることが前提

**メリット**:
- 公式サポートで安定している
- 利用規約に準拠している
- 埋め込みHTMLを取得できる

**デメリット**:
- アクセストークンが必要（`INSTAGRAM_OEMBED_TOKEN`）
- 投稿URLが既知である必要がある（自動取得は不可）
- レート制限がある

**利用規約**:
- ✅ OK（公式APIのため）

**実装参考**:
- [03 API 仕様](../03-api.md) 3.1節（Instagram Embed API）
- [02 設計資料](../02-design.md) 2.3節（キャッシュ戦略）

**適用場面**:
- スケジュールURLが既に `schedules.instagram_post_url` に登録されている場合
- 埋め込み表示のみが必要な場合

---

### 2. 手動登録フロー

**概要**:
- 人がInstagramアカウントを確認し、スケジュールURLをDBに直接書き込む
- Supabase Studio または SQLで `schedules` テーブルを更新

**メリット**:
- 確実性が高い（人が確認するため）
- 柔軟に対応できる（形式がバラバラでも対応可能）
- 利用規約の問題がない

**デメリット**:
- 工数が大きい（スケールしない）
- 更新頻度が低くなる可能性
- 人的ミスのリスク

**利用規約**:
- N/A（人手による操作のため）

**適用場面**:
- MVPでの初期実装
- 自動化が困難な場合
- データ品質を最優先する場合

---

### 3. スクレイピング（自治体サイト経由）

**概要**:
- 名古屋市の子育てサイトからInstagramアカウントURLを取得
- 既存のスクレイピングスクリプト（`apps/scripts/fetch-nagoya-childcare-bases.ts`）を拡張

**メリット**:
- 自動化可能
- 既存のスクレイピングガイドライン（[04 開発ガイド](../04-development.md) 9.5.1節）に準拠できる
- アカウントURLの一括取得が可能

**デメリット**:
- HTML構造変更に弱い
- Instagramアカウントがサイトに記載されていない場合がある
- スケジュールURLの取得は不可（アカウントURLのみ）

**利用規約**:
- ✅ OK（自治体サイトのスクレイピングは許可されている、[04 開発ガイド](../04-development.md) 9.5.1節参照）

**適用場面**:
- `facilities.instagram_url` の一括取得
- スケジュールURLの取得には不向き（アカウントURLのみ取得可能）

---

### 4. Instagram直接スクレイピング

**概要**:
- InstagramのWebページを直接スクレイピングして投稿を取得

**メリット**:
- 自動化可能
- 投稿内容を直接取得できる

**デメリット**:
- **利用規約違反のリスクが高い**（Instagramの利用規約で禁止されている可能性）
- ログインが必要な場合がある
- HTML構造が頻繁に変更される
- レート制限・ブロックのリスク

**利用規約**:
- ❌ NG（非推奨）

**適用場面**:
- **推奨しない**

---

## 比較表

| 手段 | 取得可能な情報 | 自動化 | 利用規約 | MVP適用 | 備考 |
|------|---------------|--------|----------|---------|------|
| Instagram公式API（oEmbed） | 埋め込みHTML | 部分的 | ✅ OK | ✅ | 投稿URL既知が前提 |
| 手動登録 | すべて | ❌ | N/A | ✅ | 確実だが工数大 |
| 自治体サイト経由スクレイピング | アカウントURL | ✅ | ✅ OK | ✅ | スケジュールURL取得は不可 |
| Instagram直接スクレイピング | 投稿内容 | ✅ | ❌ NG | ❌ | 非推奨 |

---

## 推奨方針（案）

### MVPでの方針案

**調査結果に基づく判断**（2025-01-22更新）:
- 名古屋市サイトの一覧ページにはInstagramリンクが含まれていない
- 詳細ページは、2025-01-22時点のサンプル3件では未検出だったが、**2025-12-16にInstagram URLが明示されている詳細ページの存在を確認**（例: `https://www.kosodate.city.nagoya.jp/play/supportbases10.html`）
  - **注意**: 詳細ページURLは `.../play/...` が正で、`/play/` 抜けは 404 になることがある
- 現在、すべての施設で `instagram_url` は `null`

**推奨方針**:

1. **InstagramアカウントURLの取得**:
   - **方法A（推奨・採用・更新）**: 詳細ページ（`detail_page_url`）からの一次ソース抽出 → 不足分を検索で補完
     - 施設名や住所から検索してInstagramアカウントを特定
     - 見つかったアカウントを `facilities.instagram_url` に手動登録
     - **更新**: 詳細ページにInstagram URLがある場合はそれを正として採用し、手動調査/検索は不足分に限定
   - **方法B（非推奨）**: 詳細ページ経由のスクレイピング
     - **更新**: 「詳細ページにリンクがない」という断定は撤回。詳細ページ抽出は有効になり得る
     - ただし全ページにある保証はないため、抽出できない分は検索で補完する

2. **スケジュールURLの登録**:
   - **手動登録を基本とする**
   - 人がInstagramアカウントを確認し、スケジュールURLを `schedules.instagram_post_url` に登録
   - すべての施設で埋まっていなくてもOK（MVPでは部分的な対応で可）
   - 投稿形式がバラバラでも柔軟に対応可能

3. **表示**:
   - Instagram公式API（oEmbed）を使用して埋め込み表示
   - 投稿URLが登録されている場合のみ表示
   - 投稿URLが無効な場合は、画像URL（`schedules.image_url`）をフォールバック表示

### 将来の拡張案

**半自動化の検討**:
- キャプションからURLを抽出するスクリプト（PoC）
  - 正規表現でURLを抽出
  - Googleドライブ、自治体サイト等のURLパターンを認識
- 定期更新フロー: 月1回程度、手動でスケジュールURLを確認・更新

**自動化の範囲**:
- InstagramアカウントURLの取得: 詳細ページにリンクがある場合は自動化可能
- スケジュールURLの取得: 投稿形式が統一されていれば自動化可能（ただし、形式がバラバラの場合は困難）

---

## 検討メモ

### 課題・懸念点

1. **Instagramアカウントの特定が困難**
   - 名古屋市サイトにInstagramリンクが含まれていない
   - 手動で検索する必要があり、工数がかかる
   - すべての施設にInstagramアカウントがあるとは限らない

2. **投稿形式の統一性がない**
   - 各施設で投稿形式が異なる可能性が高い
   - キャプション内URL、プロフィールリンク、画像そのものなど、形式がバラバラ
   - 自動化が困難

3. **更新頻度の管理**
   - 月間スケジュールは毎月更新される
   - 手動更新の場合、更新漏れのリスクがある
   - 定期更新フローの確立が必要

4. **利用規約の遵守**
   - Instagram直接スクレイピングは利用規約違反のリスク
   - 公式API（oEmbed）を使用する必要がある

### 追加調査が必要な項目

1. **詳細ページの再確認（必須）**
   - 2025-01-22はサンプル3件で未検出だったが、2025-12-16に明示リンクの存在が判明
   - 結論: 「詳細ページ→Instagram URL抽出」を一次ソースとして試し、どれだけ埋まるかを定量化する

2. **サンプルアカウントの分析**（進行中）
   - 名古屋市の子育て拠点でInstagramアカウントを公開している施設を特定
   - 2-3件のアカウントで投稿形式を分析
   - スケジュールURLの取得可能性を評価
   - **次のステップ**: 実際に2〜3施設についてInstagramアカウントを探し、投稿形式を分析

3. **投稿形式のパターン分析**（進行中）
   - キャプション内URL、プロフィールリンク、画像そのものなどの出現頻度
   - 自動化可能な形式の割合を把握
   - **次のステップ**: サンプルアカウントの分析結果を基に、パターンを整理

